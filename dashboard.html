<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä Dashboard de Pedidos</title>
<style>
    body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
    h1 { text-align: center; color: #333; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; vertical-align: middle; }
    th { background: #2f7fb3; color: white; }
    tr:hover { background: #f0f8ff; }
    select, button, input[type="number"] { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
    input[type="number"] { text-align: right; width: 80px; }
    button { background: #28a745; color: white; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #218838; }
    ul { padding-left: 15px; margin: 5px 0; text-align: left; }
    .saldo { font-weight: bold; }
    .saldo.negativo { color: #dc3545; }
    .saldo.zero { color: #28a745; }
    .status { font-weight: bold; padding: 4px 8px; border-radius: 4px; color: white; }
    .status.aguardando { background: #ffc107; }
    .status.aprovada { background: #17a2b8; }
    .status.produzindo { background: #007bff; }
    .status.finalizado { background: #28a745; }
    .status.cancelado { background: #6c757d; }
    @keyframes spinner { to { transform: rotate(360deg); } }
    .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid #ccc; border-top-color: #2f7fb3; border-radius: 50%; animation: spinner 0.6s linear infinite; }
</style>
</head>
<body>

<h1>üìä Dashboard de Pedidos</h1>

<table id="tabelaPedidos">
    <thead>
        <tr>
            <th>Cliente</th>
            <th>Produtos</th>
            <th>Quantidade</th>
            <th>Valor Unit√°rio</th>
            <th>Valor Total</th>
            <th>Valor Recebido</th>
            <th>Saldo Restante</th>
            <th>Data Pedido</th>
            <th>Data Entrega</th>
            <th>Status</th>
            <th>A√ß√£o</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="11"><span class="loading"></span> Carregando pedidos...</td></tr>
    </tbody>
</table>

<script>
const formatarMoeda = valor => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
const formatarData = dataStr => dataStr ? new Date(dataStr).toLocaleDateString('pt-BR') : "";

async function carregarPedidos() {
    const tbody = document.querySelector("#tabelaPedidos tbody");
    tbody.innerHTML = `<tr><td colspan="11"><span class="loading"></span> Carregando pedidos...</td></tr>`;

    try {
        const res = await fetch("/api/pedidos");
        if (!res.ok) throw new Error("Erro ao buscar pedidos");
        const pedidos = await res.json();

        if (!pedidos.length) {
            tbody.innerHTML = "<tr><td colspan='11'>Nenhum pedido encontrado.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        pedidos.forEach(pedido => tbody.appendChild(criarLinhaPedido(pedido)));
    } catch (err) {
        tbody.innerHTML = `<tr><td colspan='11' style='color:red'>Erro: ${err.message}</td></tr>`;
    }
}

function criarLinhaPedido(pedido) {
    const tr = document.createElement("tr");

    let produtosHTML = "<ul>", quantidadesHTML = "<ul>", valoresUnitHTML = "<ul>";
    let valorTotalPedido = 0;

    if (Array.isArray(pedido.itens)) {
        pedido.itens.forEach(item => {
            produtosHTML += `<li>${item.produto}</li>`;
            quantidadesHTML += `<li>${item.quantidade}</li>`;
            valoresUnitHTML += `<li>${formatarMoeda(item.valorUnit)}</li>`;
            valorTotalPedido += (parseFloat(item.valorUnit) || 0) * (parseInt(item.quantidade) || 0);
        });
    }
    produtosHTML += "</ul>"; quantidadesHTML += "</ul>"; valoresUnitHTML += "</ul>";

    const valorTotal = pedido.valor_total || valorTotalPedido;
    const saldo = valorTotal - (pedido.valor_recebido || 0);

    tr.innerHTML = `
        <td>${pedido.nome_cliente}</td>
        <td>${produtosHTML}</td>
        <td>${quantidadesHTML}</td>
        <td>${valoresUnitHTML}</td>
        <td>${formatarMoeda(valorTotal)}</td>
        <td>
            <input type="number" step="0.01" value="${pedido.valor_recebido || 0}" 
                onchange="atualizarValorRecebido('${pedido.id}', this.value)">
        </td>
        <td id="saldo-${pedido.id}" class="saldo ${saldo <= 0 ? 'zero' : 'negativo'}">${formatarMoeda(saldo)}</td>
        <td>${formatarData(pedido.data_pedido)}</td>
        <td>${formatarData(pedido.data_entrega)}</td>
        <td>
            <select onchange="atualizarStatus('${pedido.id}', this.value)">
                ${['Aguardando Retorno','Arte Aprovada','Produzindo','Pedido Finalizado','Cancelado'].map(st => 
                    `<option value="${st}" ${pedido.status === st ? "selected" : ""}>${st}</option>`).join('')}
            </select>
        </td>
        <td><button onclick="removerPedido('${pedido.id}')">üóëÔ∏è Remover</button></td>
    `;
    return tr;
}

async function atualizarStatus(id, novoStatus) {
    await fetch(`/api/pedidos/${id}`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: novoStatus })
    });
}

async function atualizarValorRecebido(id, valor) {
    await fetch(`/api/pedidos/${id}`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ valorRecebido: parseFloat(valor) })
    });
    carregarPedidos();
}

async function removerPedido(id) {
    if (!confirm("Deseja realmente remover este pedido?")) return;
    await fetch(`/api/pedidos/${id}`, { method: 'DELETE' });
    carregarPedidos();
}

carregarPedidos();
</script>

</body>
</html>
