<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä Dashboard de Pedidos</title>
<style>
body { font-family: Arial, sans-serif; background-color: #ffffff; padding: 20px; }
h1 { text-align: center; color: #333; }
table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; vertical-align: middle; }
th { background: #2f7fb3; color: white; }
select, button, input[type="number"] { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
input[type="number"] { text-align: right; width: 80px; }
button { background: green; color: white; cursor: pointer; }
button:hover { background: darkgreen; }
ul { padding-left: 15px; margin: 5px 0; text-align: left; }
.saldo { font-weight: bold; color: #dc3545; display: block; margin-top: 5px; }
</style>
</head>
<body>

<h1>üìä Dashboard de Pedidos</h1>

<table id="tabelaPedidos">
    <thead>
        <tr>
            <th>Cliente</th>
            <th>Produtos</th>
            <th>Quantidade</th>
            <th>Valor Unit√°rio (R$)</th>
            <th>Valor Total (R$)</th>
            <th>Valor Recebido (R$)</th>
            <th>Saldo Restante (R$)</th>
            <th>Data Pedido</th>
            <th>Data Entrega</th>
            <th>Status</th>
            <th>A√ß√£o</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
function formatarData(dataStr) {
    if (!dataStr) return "";
    const data = new Date(dataStr);
    return `${String(data.getDate()).padStart(2,'0')}/${String(data.getMonth()+1).padStart(2,'0')}/${data.getFullYear()}`;
}

async function carregarPedidos() {
    const tbody = document.querySelector("#tabelaPedidos tbody");
    tbody.innerHTML = "<tr><td colspan='11'>Carregando pedidos...</td></tr>";
    try {
        const res = await fetch("/api/pedidos");
        if (!res.ok) throw new Error("Erro ao buscar pedidos");
        const pedidos = await res.json();

        if (!pedidos.length) {
            tbody.innerHTML = "<tr><td colspan='11'>Nenhum pedido encontrado.</td></tr>";
            return;
        }

        tbody.innerHTML = "";

        pedidos.forEach(pedido => {
            let produtosHTML="<ul>", quantHTML="<ul>", valUnitHTML="<ul>";
            let total = 0;
            (pedido.itens || []).forEach(item => {
                produtosHTML += `<li>${item.produto}</li>`;
                quantHTML += `<li>${item.quantidade}</li>`;
                valUnitHTML += `<li>R$ ${parseFloat(item.valorUnit).toFixed(2)}</li>`;
                total += parseFloat(item.valorUnit || 0) * parseInt(item.quantidade || 0);
            });
            produtosHTML+="</ul>"; quantHTML+="</ul>"; valUnitHTML+="</ul>";
            if (!pedido.valor_total) pedido.valor_total = total;
            const saldo = (pedido.valor_total - (pedido.valor_recebido || 0)).toFixed(2);

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${pedido.nome_cliente}</td>
                <td>${produtosHTML}</td>
                <td>${quantHTML}</td>
                <td>${valUnitHTML}</td>
                <td>R$ ${parseFloat(pedido.valor_total).toFixed(2)}</td>
                <td><input type="number" step="0.01" value="${pedido.valor_recebido || 0}" onchange="atualizarValor('${pedido.id}', this.value)"></td>
                <td class="saldo" id="saldo-${pedido.id}">R$ ${saldo}</td>
                <td>${formatarData(pedido.data_pedido)}</td>
                <td>${formatarData(pedido.data_entrega)}</td>
                <td>
                    <select onchange="atualizarStatus('${pedido.id}', this.value)">
                        <option value="Aguardando Retorno" ${pedido.status==='Aguardando Retorno'?'selected':''}>Aguardando Retorno</option>
                        <option value="Arte Aprovada" ${pedido.status==='Arte Aprovada'?'selected':''}>Arte Aprovada</option>
                        <option value="Produzindo" ${pedido.status==='Produzindo'?'selected':''}>Produzindo</option>
                        <option value="Pedido Finalizado" ${pedido.status==='Pedido Finalizado'?'selected':''}>Pedido Finalizado</option>
                        <option value="Cancelado" ${pedido.status==='Cancelado'?'selected':''}>Cancelado</option>
                    </select>
                </td>
                <td><button onclick="remover('${pedido.id}')">üóëÔ∏è Remover</button></td>
            `;
            tbody.appendChild(tr);
        });

    } catch(err) {
        tbody.innerHTML = `<tr><td colspan='11' style="color:red">${err.message}</td></tr>`;
    }
}

async function atualizarStatus(id, status) {
    try {
        const res = await fetch(`/api/pedidos`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ id, status })
        });
        if (!res.ok) throw new Error("Erro ao atualizar status");
        const data = await res.json();
        document.getElementById(`saldo-${id}`).textContent = `R$ ${(data.pedido.valor_total - data.pedido.valor_recebido).toFixed(2)}`;
    } catch(err) { alert(err.message); }
}

async function atualizarValor(id, valor) {
    valor = parseFloat(valor) || 0;
    try {
        const res = await fetch(`/api/pedidos`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ id, valorRecebido: valor })
        });
        if (!res.ok) throw new Error("Erro ao atualizar valor");
        const data = await res.json();
        document.getElementById(`saldo-${id}`).textContent = `R$ ${(data.pedido.valor_total - data.pedido.valor_recebido).toFixed(2)}`;
    } catch(err) { alert(err.message); }
}

async function remover(id) {
    if (!confirm("Deseja realmente remover este pedido?")) return;
    try {
        const res = await fetch(`/api/pedidos`, {
            method:'DELETE',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ id })
        });
        if (!res.ok) throw new Error("Erro ao remover pedido");
        await res.json();
        carregarPedidos();
    } catch(err) { alert(err.message); }
}

carregarPedidos();
</script>

</body>
</html>
