<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“¦ Meus Pedidos</title>
<style>
body{font-family:"Segoe UI",Arial,sans-serif;background:#f4f7fb;margin:0;padding:20px;}
h1{text-align:center;color:#2f7fb3;margin-bottom:20px;}
.pedido-card{background:white;border-radius:10px;box-shadow:0px 3px 10px rgba(0,0,0,0.1);padding:15px;margin-bottom:15px;transition:0.3s;}
.pedido-card:hover{transform:translateY(-3px);box-shadow:0px 5px 15px rgba(0,0,0,0.15);}
.pedido-header{display:flex;justify-content:space-between;align-items:center;font-weight:bold;color:#333;flex-wrap:wrap;cursor:pointer;}
.pedido-info{margin-top:10px;font-size:14px;color:#555;display:none;}
.pedido-info ul{padding-left:20px;margin:5px 0;}
.status{padding:5px 10px;border-radius:6px;font-size:12px;font-weight:bold;}
.pendente{background:#ffeb99;color:#a67c00;}
.aprovada{background:#cce5ff;color:#004085;}
.finalizado{background:#d4edda;color:#155724;}
.cancelado{background:#f8d7da;color:#721c24;}
.voltar{display:block;text-align:center;margin-top:20px;background:#2f7fb3;color:white;padding:10px;border-radius:8px;text-decoration:none;font-weight:bold;}
.voltar:hover{background:#25658d;}
.show{display:block;}
.toggle-button{font-size:12px;color:#2f7fb3;text-decoration:underline;cursor:pointer;margin-top:5px;}
</style>
</head>
<body>
<h1>ðŸ“¦ Meus Pedidos</h1>
<div id="listaPedidos"></div>
<a href="index.html" class="voltar">â¬… Voltar</a>

<script>
function formatarData(dataStr){
    if(!dataStr) return "-";
    const d = new Date(dataStr);
    return d.toLocaleDateString("pt-BR");
}

function formatarValor(valor){
    return parseFloat(valor||0).toFixed(2).replace(".",",");
}

async function carregarPedidos(){
    const lista = document.getElementById("listaPedidos");
    lista.innerHTML = "<p style='text-align:center;color:#666;'>Carregando pedidos...</p>";

    try{
        const res = await fetch("/api/pedidos");
        const pedidos = await res.json();

        if(!pedidos || pedidos.length===0){
            lista.innerHTML = "<p style='text-align:center;color:#666;'>Nenhum pedido encontrado.</p>";
            return;
        }

        // Ordena por data mais recente
        pedidos.sort((a,b)=>new Date(b.data_pedido) - new Date(a.data_pedido));

        lista.innerHTML = "";
        pedidos.forEach(p=>{
            const card = document.createElement("div");
            card.classList.add("pedido-card");

            // Status
            let statusClasse="pendente";
            const s = (p.status||"").toLowerCase();
            if(s.includes("aprovada")) statusClasse="aprovada";
            else if(s.includes("finalizado")) statusClasse="finalizado";
            else if(s.includes("cancelado")) statusClasse="cancelado";

            // Produtos
            let produtosHTML="<ul>";
            if(p.itens){
                const itens = Array.isArray(p.itens) ? p.itens : JSON.parse(p.itens);
                itens.forEach(i=>{
                    produtosHTML += `<li>${i.produto} - ${i.quantidade} un. (R$ ${formatarValor(i.valorUnit)}) - Total: R$ ${formatarValor(i.total)}</li>`;
                });
            }
            produtosHTML += "</ul>";

            // Preenche o card
            card.innerHTML=`
                <div class="pedido-header">
                    <span>ðŸ“‹ Pedido de ${p.vendedor}</span>
                    <span class="status ${statusClasse}">${p.status||"Aguardando Retorno"}</span>
                </div>
                <div class="pedido-info">
                    <p><b>Cliente:</b> ${p.nome_cliente}</p>
                    <p><b>Telefone:</b> ${p.telefone_cliente}</p>
                    <p><b>Valor Total do Pedido:</b> R$ ${formatarValor(p.valor_total)}</p>
                    <p><b>Valor Recebido:</b> R$ ${formatarValor(p.valor_recebido)}</p>
                    <p><b>Data Pedido:</b> ${formatarData(p.data_pedido)}</p>
                    <p><b>Data Entrega:</b> ${formatarData(p.data_entrega)}</p>
                    <p class="toggle-button">Mostrar Produtos</p>
                    <div class="produtos" style="display:none;">${produtosHTML}</div>
                </div>
            `;
            lista.appendChild(card);

            // Toggle produtos
            const toggleBtn = card.querySelector(".toggle-button");
            const produtosDiv = card.querySelector(".produtos");
            toggleBtn.addEventListener("click", ()=>{
                produtosDiv.style.display = produtosDiv.style.display === "none" ? "block" : "none";
                toggleBtn.textContent = produtosDiv.style.display === "none" ? "Mostrar Produtos" : "Ocultar Produtos";
            });
        });
    }catch(err){
        lista.innerHTML=`<p style='text-align:center;color:red;'>Erro ao carregar pedidos: ${err.message}</p>`;
    }
}

carregarPedidos();
</script>
</body>
</html>
